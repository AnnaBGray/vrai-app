<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Profile - Vrai</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Playfair+Display:wght@500;600&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#89CFF0',
                        'primary-dark': '#7ab8d9',
                    },
                    fontFamily: {
                        'sans': ['Inter', 'sans-serif'],
                        'display': ['Playfair Display', 'serif'],
                    },
                }
            }
        }
    </script>
    <!-- Shared Navigation and Authentication -->
    <link rel="stylesheet" href="styles.css">
</head>
<body class="min-h-screen bg-[#EAF6FC] font-sans text-[#1A1A1A] antialiased">
    <!-- Fixed Top Navigation Bar -->
    <div class="fixed top-0 left-0 right-0 z-50 bg-white border-b border-gray-100 shadow-sm">
        <div class="max-w-md mx-auto px-4 py-4 flex items-center justify-between">
            <button onclick="window.location.href='settings.html'" class="flex items-center justify-center w-10 h-10 rounded-lg">
                <svg class="w-6 h-6 text-gray-600" viewBox="0 0 24 24" fill="none">
                    <path d="M19 12H5M12 19L5 12L12 5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
            <h1 class="font-display text-lg font-semibold text-gray-900">Edit Profile</h1>
            <div class="w-10"></div> <!-- Spacer for centering -->
        </div>
    </div>

    <!-- Main Content -->
    <div class="w-full max-w-md mx-auto pb-20">
        <!-- Profile Photo Section -->
        <div class="px-4 pt-20 pb-6">
            <div class="flex flex-col items-center mb-8">
                <div class="relative mb-4">
                    <div id="profileIcon" class="w-24 h-24 rounded-full bg-gray-200 flex items-center justify-center text-gray-600 font-semibold text-2xl overflow-hidden shadow-lg border-4 border-white">
                        <span id="userInitials">SJ</span>
                        <img id="profileImage" class="w-full h-full object-cover hidden" alt="Profile Photo">
                    </div>
                    <!-- Camera Icon Overlay -->
                    <label for="profilePhotoInput" class="absolute -bottom-1 -right-1 w-8 h-8 bg-primary-500 rounded-full flex items-center justify-center cursor-pointer shadow-lg  border-2 border-white">
                        <svg class="w-4 h-4 text-white" viewBox="0 0 24 24" fill="none">
                            <path d="M12 15.2C13.7673 15.2 15.2 13.7673 15.2 12C15.2 10.2327 13.7673 8.8 12 8.8C10.2327 8.8 8.8 10.2327 8.8 12C8.8 13.7673 10.2327 15.2 12 15.2ZM12 17C14.7614 17 17 14.7614 17 12C17 9.23858 14.7614 7 12 7C9.23858 7 7 9.23858 7 12C7 14.7614 9.23858 17 12 17ZM12 4.5C12.8284 4.5 13.5 3.82843 13.5 3C13.5 2.17157 12.8284 1.5 12 1.5C11.1716 1.5 10.5 2.17157 10.5 3C10.5 3.82843 11.1716 4.5 12 4.5ZM19 4.5C19.8284 4.5 20.5 3.82843 20.5 3C20.5 2.17157 19.8284 1.5 19 1.5C18.1716 1.5 17.5 2.17157 17.5 3C17.5 3.82843 18.1716 4.5 19 4.5ZM21 19H3C2.45 19 2 18.55 2 18V6C2 5.45 2.45 5 3 5H7L9 3H15L17 5H21C21.55 5 22 5.45 22 6V18C22 18.55 21.55 19 21 19ZM20 17H4V7H20V17Z" fill="currentColor"/>
                        </svg>
                    </label>
                    <input type="file" id="profilePhotoInput" class="hidden" accept="image/*">
                </div>
                <p class="text-sm text-gray-500 text-center">Tap to change profile photo</p>
            </div>
        </div>

        <!-- Card Layout -->
        <div class="px-4">
            <div class="bg-white rounded-2xl shadow-sm p-6">
                <form id="editProfileForm" class="space-y-6">
                    <!-- Full Name (Editable) -->
                    <div class="space-y-2">
                        <label for="fullName" class="block text-sm font-medium text-gray-700">Full Name</label>
                        <input 
                            type="text" 
                            id="fullName" 
                            name="fullName" 
                            value="Loading..." 
                            class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary-500/20 focus:border-primary-500 transition-colors text-gray-900"
                            placeholder="e.g. Annabella Gray"
                        >
                        <p class="text-xs text-gray-400">Your legal name, used only for official reports.</p>
                    </div>

                <!-- Display Name (previously Username) -->
                <div class="space-y-2">
                    <label for="username" class="block text-sm font-medium text-gray-700">Display Name</label>
                    <input 
                        type="text" 
                        id="username" 
                        name="username" 
                        value="Loading..." 
                        class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary-500/20 focus:border-primary-500 transition-colors text-gray-900"
                        placeholder="e.g. Anna"
                    >
                    <p class="text-xs text-gray-400">This name will appear on your profile.</p>
                </div>

                <!-- Email Address -->
                <div class="space-y-2">
                    <label for="email" class="block text-sm font-medium text-gray-700">Email Address</label>
                    <input 
                        type="email" 
                        id="email" 
                        name="email" 
                        value="Loading..." 
                        class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary-500/20 focus:border-primary-500 transition-colors text-gray-900"
                        placeholder="e.g. anna@example.com"
                    >
                    <p class="text-xs text-gray-400">Your email address for account notifications.</p>
                </div>

                <!-- Mobile Number -->
                <div class="space-y-2">
                    <label for="phone_number" class="block text-sm font-medium text-gray-700">Mobile Number</label>
                    <input 
                        type="tel" 
                        id="phone_number" 
                        name="phone_number" 
                        value="Loading..." 
                        class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary-500/20 focus:border-primary-500 transition-colors text-gray-900"
                        placeholder="e.g. +60162393100"
                    >
                </div>
            </form>
        </div>
    </div>

    <!-- Fixed Save Button -->
    <div class="fixed bottom-0 left-0 right-0 z-40 bg-white border-t border-gray-100 p-4">
        <div class="max-w-md mx-auto">
            <button id="saveButton" class="w-full bg-gray-300 text-gray-500 font-medium py-3 px-4 rounded-xl text-base transition-all duration-200 cursor-not-allowed" disabled>
                Save Changes
            </button>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div id="successToast" class="fixed top-20 left-1/2 transform -translate-x-1/2 bg-green-500 text-white px-6 py-3 rounded-xl shadow-lg z-50 hidden">
        <div class="flex items-center space-x-2">
            <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none">
                <path d="M9 12L11 14L15 10M21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3C16.9706 3 21 7.02944 21 12Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <span>Profile updated successfully!</span>
        </div>
    </div>

    <div id="errorToast" class="fixed top-20 left-1/2 transform -translate-x-1/2 bg-red-500 text-white px-6 py-3 rounded-xl shadow-lg z-50 hidden">
        <div class="flex items-center space-x-2">
            <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none">
                <path d="M12 8V12M12 16H12.01M21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3C16.9706 3 21 7.02944 21 12Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <span id="errorMessage">An error occurred</span>
        </div>
    </div>

    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-init.js"></script>
    <script>
        // Use the shared Supabase client from supabase-init.js
        const supabase = window.supabaseClient;

        // Load user profile from Supabase
        async function loadUserProfile() {
            try {
                console.log('ðŸ”„ Attempting to load profile from Supabase...');
                
                // Get current user from Supabase Auth
                const { data: { user }, error: authError } = await supabase.auth.getUser();
                
                if (authError) {
                    console.error('âŒ Supabase Auth error:', authError);
                    throw new Error('Failed to authenticate user');
                }
                
                if (!user) {
                    console.error('âŒ No authenticated user found');
                    throw new Error('No authenticated user found');
                }
                
                console.log('ðŸ“ Found authenticated user:', user.id);
                
                // Fetch profile directly from Supabase profiles table
                const { data: profile, error: profileError } = await supabase
                    .from('profiles')
                    .select('*')
                    .eq('id', user.id)
                    .single();
                
                if (profileError) {
                    console.error('âŒ Supabase profile fetch error:', profileError);
                    throw new Error('Failed to fetch profile: ' + profileError.message);
                }
                
                if (!profile) {
                    console.warn('âš ï¸ No profile found for user:', user.id);
                    throw new Error('No profile found for user');
                }
                
                console.log('âœ… Profile loaded successfully from Supabase:', profile);
                
                // Update form fields with profile data
                updateFormFields(profile);
                
                return profile;
                
            } catch (error) {
                console.error('âŒ Supabase Auth profile loading failed:', error.message);
                // Redirect to login for any error
                alert('Authentication error: ' + error.message + '. Please log in again.');
                window.location.href = 'index.html';
                return null;
            }
        }
        
        // Update form fields with profile data
        function updateFormFields(profile) {
            console.log('ðŸŽ¨ Updating form fields with:', profile);
            
            // Update full name (legal name)
            const fullNameInput = document.getElementById('fullName');
            if (fullNameInput) {
                fullNameInput.value = profile.full_name || '';
            }
            
            // Update display name (previously username)
            const usernameInput = document.getElementById('username');
            if (usernameInput) {
                usernameInput.value = profile.display_name || '';
            }
            
            // Update email
            const emailInput = document.getElementById('email');
            if (emailInput) {
                emailInput.value = profile.email || '';
            }
            
            // Update phone number if available
            const phoneInput = document.getElementById('phone_number');
            
            // Check all possible phone number field names
            const phoneNumber = profile.phone_number || profile.phone || '';
            
            if (phoneNumber) {
                console.log('ðŸ“± Found phone number:', phoneNumber);
                phoneInput.value = phoneNumber;
            } else {
                // Set default values if no phone number is available
                if (phoneInput) {
                    phoneInput.value = '';
                }
            }
            
            // Update profile photo if available
            const profileImage = document.getElementById('profileImage');
            const userInitials = document.getElementById('userInitials');

            if (profile.avatar_url) {
                console.log('ðŸ–¼ï¸ Setting profile image:', profile.avatar_url);
                profileImage.src = profile.avatar_url;
                profileImage.classList.remove('hidden');
                userInitials.classList.add('hidden');
            } else {
                console.log('ðŸ‘¤ No avatar, showing initials');
                // Show initials based on display name
                const initials = getUserInitials(profile.display_name || profile.full_name || 'User');
                userInitials.textContent = initials;
                userInitials.classList.remove('hidden');
                profileImage.classList.add('hidden');
            }
        }
        
        // Function to get user initials from name
        function getUserInitials(userName = 'User') {
            const names = userName.split(' ');
            if (names.length >= 2) {
                return (names[0].charAt(0) + names[1].charAt(0)).toUpperCase();
            } else if (names.length === 1) {
                return names[0].charAt(0).toUpperCase();
            }
            return 'U';
        }

        // Store original form data for comparison
        let originalFormData = null;

        document.addEventListener('DOMContentLoaded', async function() {
            console.log('ðŸš€ Initializing edit profile page...');
            
            // Load user profile from Supabase first
            await loadUserProfile();
            
            // Form change tracking
            const form = document.getElementById('editProfileForm');
            const saveButton = document.getElementById('saveButton');
            const successToast = document.getElementById('successToast');
            
            console.log('ðŸ” Save button found:', saveButton);
            console.log('ðŸ” Form found:', form);
            
            // Initialize original form data after a short delay to ensure all fields are populated
            setTimeout(() => {
                originalFormData = new FormData(form);
                console.log('ðŸ“ Original form data stored after profile load');
                // Initialize button state
                checkForChanges();
                
                // Enable form fields after original data is captured
                form.querySelectorAll('input, select').forEach(input => {
                    if (input.id !== 'profilePhotoInput') {
                        input.disabled = false;
                    }
                });
                
                console.log('âœ… Form initialization complete');
            }, 300);
            
            let hasChanges = false;

            // Track form changes
            function checkForChanges() {
                if (!originalFormData) {
                    console.log('âš ï¸ No original form data available');
                    return;
                }
                
                hasChanges = false;
                
                // Check each input field individually
                const fullName = document.getElementById('fullName').value;
                const username = document.getElementById('username').value;
                const email = document.getElementById('email').value;
                const phone = document.getElementById('phone_number').value;
                
                console.log('ðŸ” Checking form changes:', {
                    fullName: fullName,
                    username: username,
                    email: email,
                    phone: phone,
                    originalFullName: originalFormData.get('fullName'),
                    originalUsername: originalFormData.get('username'),
                    originalEmail: originalFormData.get('email'),
                    originalPhone: originalFormData.get('phone_number')
                });
                
                // Compare with original values
                if (fullName !== originalFormData.get('fullName') ||
                    username !== originalFormData.get('username') ||
                    email !== originalFormData.get('email') ||
                    phone !== originalFormData.get('phone_number')) {
                    hasChanges = true;
                }

                console.log('ðŸ“Š Form has changes:', hasChanges);

                // Update button state
                if (hasChanges) {
                    console.log('âœ… Enabling save button');
                    saveButton.classList.remove('bg-gray-300', 'text-gray-500', 'cursor-not-allowed');
                    saveButton.classList.add('bg-[#89CFF0]', 'text-white');
                    saveButton.disabled = false;
                } else {
                    console.log('âŒ Disabling save button');
                    saveButton.classList.remove('bg-[#89CFF0]', 'text-white');
                    saveButton.classList.add('bg-gray-300', 'text-gray-500', 'cursor-not-allowed');
                    saveButton.disabled = true;
                }
                
                console.log('Form changed:', hasChanges);
            }
            
            const profilePhotoInput = document.getElementById('profilePhotoInput');
            const profileImage = document.getElementById('profileImage');
            const userInitials = document.getElementById('userInitials');

            // Handle profile photo upload
            profilePhotoInput.addEventListener('change', async function(event) {
                const file = event.target.files[0];
                if (file) {
                    // Validate file type
                    if (!file.type.startsWith('image/')) {
                        alert('Please select an image file.');
                        return;
                    }

                    // Validate file size (max 5MB)
                    if (file.size > 5 * 1024 * 1024) {
                        alert('Please select an image smaller than 5MB.');
                        return;
                    }

                    try {
                        // Show loading indicator
                        const originalText = userInitials.textContent;
                        userInitials.innerHTML = '<svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>';
                        
                        // Get current user from Supabase Auth
                        const { data: { user }, error: authError } = await supabase.auth.getUser();
                        
                        if (authError) {
                            throw new Error('Authentication error: ' + authError.message);
                        }
                        
                        if (!user) {
                            throw new Error('No authenticated user found');
                        }
                        
                        const userId = user.id;
                        
                        // Generate a unique file name
                        const fileExt = file.name.split('.').pop();
                        const fileName = `${userId}-${Date.now()}.${fileExt}`;
                        const filePath = `${userId}/${fileName}`;
                        
                        // Upload to Supabase Storage
                        const { error: uploadError } = await supabase.storage
                            .from('avatars')
                            .upload(filePath, file);
                            
                        if (uploadError) {
                            throw new Error(`Upload failed: ${uploadError.message}`);
                        }
                        
                        console.log('âœ… File uploaded successfully to path:', filePath);
                        
                        // Get the public URL of the uploaded file
                        const { data: urlData } = supabase.storage
                            .from('avatars')
                            .getPublicUrl(filePath);
                        
                        const avatarUrl = urlData.publicUrl;
                        console.log('ðŸ”— Avatar public URL:', avatarUrl);
                        
                        // Update the user's profile with the new avatar URL
                        const { error: updateError } = await supabase
                            .from('profiles')
                            .update({ avatar_url: avatarUrl })
                            .eq('id', userId);
                        
                        if (updateError) {
                            throw new Error(`Profile update failed: ${updateError.message}`);
                        }
                        
                        console.log('âœ… Profile updated with new avatar URL');
                        
                        // Save avatar URL to localStorage for fallback
                        localStorage.setItem('userProfilePhoto', avatarUrl);
                        
                        // Update display
                        profileImage.src = avatarUrl;
                        profileImage.classList.remove('hidden');
                        userInitials.classList.add('hidden');
                        
                        console.log('ðŸŽ‰ Avatar upload and profile update completed successfully');
                        
                    } catch (error) {
                        console.error('âŒ Avatar upload error:', error);
                        alert('Failed to upload avatar: ' + error.message);
                        
                        // Restore original display
                        userInitials.textContent = originalText;
                        userInitials.classList.remove('hidden');
                        profileImage.classList.add('hidden');
                    }
                }
            });

            // Add event listeners to all form inputs
            form.querySelectorAll('input, select').forEach(input => {
                console.log('ðŸ“ Adding event listeners to:', input.id);
                input.addEventListener('input', checkForChanges);
                input.addEventListener('change', checkForChanges);
                input.addEventListener('blur', checkForChanges);
                input.addEventListener('keyup', checkForChanges);
            });
            
            console.log('âœ… Event listeners added to all form fields');

            // Save profile to Supabase
            async function saveProfileToSupabase(profileData) {
                try {
                    console.log('ðŸ”„ Attempting to save profile to Supabase...');
                    
                    // Get current user from Supabase Auth
                    const { data: { user }, error: authError } = await supabase.auth.getUser();
                    
                    if (authError) {
                        console.error('âŒ Supabase Auth error:', authError);
                        throw new Error('Failed to authenticate user');
                    }
                    
                    if (!user) {
                        console.error('âŒ No authenticated user found');
                        throw new Error('No authenticated user found');
                    }
                    
                    const userId = user.id;
                    console.log('ðŸ“ Using Supabase Auth userId for update:', userId);
                    
                    // Use the phone number as-is to preserve the format with country code
                    const phoneNumber = profileData.phone;
                    
                    // Prepare data for Supabase update
                    const updateData = {
                        id: userId,
                        full_name: profileData.fullName,
                        display_name: profileData.username,
                        email: profileData.email,
                        phone_number: phoneNumber,
                        updated_at: new Date().toISOString()
                    };
                    
                    console.log('ðŸ“Š Updating profile with data:', updateData);
                    
                    // Update profile in Supabase
                    const { data, error } = await supabase
                        .from('profiles')
                        .upsert(updateData)
                        .eq('id', userId);
                    
                    if (error) {
                        console.error('âŒ Supabase update failed:', error);
                        throw new Error(`Failed to update profile: ${error.message}`);
                    }
                    
                    console.log('âœ… Profile updated successfully in Supabase');
                    
                    return { success: true };
                } catch (error) {
                    console.error('âŒ Profile update error:', error);
                    return { 
                        success: false, 
                        error: error.message || 'Failed to update profile'
                    };
                }
            }

            // Handle form submission
            saveButton.addEventListener('click', async function(e) {
                e.preventDefault();
                
                if (!hasChanges) return;

                // Show loading state
                saveButton.textContent = 'Saving...';
                saveButton.disabled = true;

                try {
                    // Get form data
                    const formData = {
                        fullName: document.getElementById('fullName').value,
                        username: document.getElementById('username').value,
                        email: document.getElementById('email').value,
                        phone: document.getElementById('phone_number').value
                    };
                    
                    // Save to Supabase
                    const result = await saveProfileToSupabase(formData);
                    
                    if (result.success) {
                        // Update original form data
                        originalFormData = new FormData(form);
                        hasChanges = false;
                        
                        // Show success toast
                        successToast.classList.remove('hidden');
                        setTimeout(() => {
                            successToast.classList.add('hidden');
                        }, 3000);
                    } else {
                        // Show error toast
                        const errorMessage = document.getElementById('errorMessage');
                        errorMessage.textContent = `Failed to update profile: ${result.error}`;
                        
                        const errorToast = document.getElementById('errorToast');
                        errorToast.classList.remove('hidden');
                        setTimeout(() => {
                            errorToast.classList.add('hidden');
                        }, 3000);
                    }
                } catch (error) {
                    console.error('âŒ Error saving profile:', error);
                    
                    // Show error toast
                    const errorMessage = document.getElementById('errorMessage');
                    errorMessage.textContent = 'An error occurred while saving your profile. Please try again.';
                    
                    const errorToast = document.getElementById('errorToast');
                    errorToast.classList.remove('hidden');
                    setTimeout(() => {
                        errorToast.classList.add('hidden');
                    }, 3000);
                } finally {
                    // Update button state
                    saveButton.textContent = 'Save Changes';
                    if (hasChanges) {
                        saveButton.classList.add('bg-[#89CFF0]', 'text-white');
                        saveButton.classList.remove('bg-gray-300', 'text-gray-500', 'cursor-not-allowed');
                        saveButton.disabled = false;
                    } else {
                        saveButton.classList.remove('bg-[#89CFF0]', 'text-white');
                        saveButton.classList.add('bg-gray-300', 'text-gray-500', 'cursor-not-allowed');
                        saveButton.disabled = true;
                    }
                }
            });

            // Initialize form state
            checkForChanges();
        });
    </script>
</body>
</html>